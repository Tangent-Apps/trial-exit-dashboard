<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trial Exit Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2e3345;
    --text: #e1e4ed;
    --text-dim: #8b90a0;
    --green: #34d399;
    --red: #f87171;
    --yellow: #fbbf24;
    --blue: #60a5fa;
    --purple: #a78bfa;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }

  .header h1 { font-size: 20px; font-weight: 600; letter-spacing: -0.02em; }

  .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

  select, button {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    outline: none;
  }

  select:hover, button:hover { border-color: var(--blue); }

  button.primary {
    background: var(--blue);
    border-color: var(--blue);
    color: #fff;
    font-weight: 500;
  }

  button.primary:hover { background: #4f8fef; }

  button.danger {
    background: rgba(248,113,113,0.15);
    border-color: var(--red);
    color: var(--red);
    font-size: 12px;
    padding: 6px 10px;
  }

  button.danger:hover { background: rgba(248,113,113,0.3); }

  .container { padding: 24px 32px; max-width: 1400px; margin: 0 auto; }

  /* Upload zone — full (no data) */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 40px 24px;
    text-align: center;
    margin-bottom: 24px;
    transition: all 0.2s;
    cursor: pointer;
    background: var(--surface);
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--blue);
    background: rgba(96,165,250,0.05);
  }

  .upload-zone h3 { font-size: 16px; margin-bottom: 8px; }
  .upload-zone p { font-size: 13px; color: var(--text-dim); }
  .upload-zone input[type="file"] { display: none; }

  .upload-row {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    margin-top: 16px;
    flex-wrap: wrap;
  }

  .upload-row label { font-size: 13px; color: var(--text-dim); }

  /* Upload zone — compact (has data) */
  .upload-zone.compact {
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    text-align: left;
    border-style: solid;
    border-width: 1px;
  }

  .upload-zone.compact h3 { font-size: 13px; margin: 0; color: var(--text-dim); white-space: nowrap; }
  .upload-zone.compact p { display: none; }
  .upload-zone.compact .upload-row { margin-top: 0; }

  /* Processing indicator */
  .processing {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: rgba(96,165,250,0.1);
    border: 1px solid rgba(96,165,250,0.3);
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 14px;
  }

  .spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--blue);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Metrics cards */
  .metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .metric-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .metric-card .label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .metric-card .value { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; }
  .metric-card .sub { font-size: 13px; color: var(--text-dim); margin-top: 4px; }
  .metric-card .delta { font-size: 13px; margin-top: 4px; font-weight: 500; }

  .delta.up { color: var(--green); }
  .delta.down { color: var(--red); }
  .delta.neutral { color: var(--text-dim); }

  /* Charts */
  .chart-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .chart-container h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
  .chart-wrapper { position: relative; height: 320px; }

  /* Tables */
  .tables-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  @media (max-width: 900px) { .tables-row { grid-template-columns: 1fr; } }

  .table-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    overflow-x: auto;
  }

  .table-container h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }

  th {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 500;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  .text-right { text-align: right; }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
  }

  .badge-green { background: rgba(52,211,153,0.15); color: var(--green); }
  .badge-red { background: rgba(248,113,113,0.15); color: var(--red); }
  .badge-yellow { background: rgba(251,191,36,0.15); color: var(--yellow); }

  .empty-state {
    text-align: center;
    padding: 60px 24px;
    color: var(--text-dim);
  }

  .empty-state h2 { font-size: 20px; margin-bottom: 8px; color: var(--text); }

  .history-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .history-bar .snapshots-info { font-size: 13px; color: var(--text-dim); }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 14px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    animation: fadeIn 0.3s;
    max-width: 400px;
  }

  .toast.success { background: rgba(52,211,153,0.2); border: 1px solid var(--green); color: var(--green); }
  .toast.error { background: rgba(248,113,113,0.2); border: 1px solid var(--red); color: var(--red); }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>

<div class="header">
  <h1>Trial Exit Dashboard</h1>
  <div class="controls">
    <select id="appSelector">
      <option value="">Select app</option>
    </select>
    <select id="rangeSelector">
      <option value="30">Last 30 days</option>
      <option value="60">Last 60 days</option>
      <option value="90">Last 90 days</option>
      <option value="0" selected>All time</option>
    </select>
    <button class="danger" id="clearBtn" style="display:none" title="Clear all stored data for this app">Clear history</button>
  </div>
</div>

<div class="container">
  <div class="upload-zone" id="uploadZone">
    <h3>Upload RevenueCat Export</h3>
    <p>Drag & drop a .csv or .csv.gz file (RC "All Users" export)</p>
    <div class="upload-row">
      <label for="uploadAppSelect">App:</label>
      <select id="uploadAppSelect">
        <option value="christian-daily-task">Christian Daily Task</option>
        <option value="girlwalk">GirlWalk</option>
        <option value="girltalk">GirlTalk</option>
      </select>
      <button class="primary" id="browseBtn">Browse files</button>
      <input type="file" id="fileInput" accept=".csv,.gz,.csv.gz">
    </div>
  </div>

  <div id="processingIndicator" style="display:none">
    <div class="processing">
      <div class="spinner"></div>
      <span>Processing CSV...</span>
    </div>
  </div>

  <div id="content">
    <div class="empty-state">
      <h2>No data yet</h2>
      <p>Upload a RevenueCat "All Users" CSV export to get started.</p>
    </div>
  </div>
</div>

<script>
const APPS = {
  'christian-daily-task': { name: 'Christian Daily Task' },
  'girlwalk': { name: 'GirlWalk' },
  'girltalk': { name: 'GirlTalk' },
};

const STORAGE_KEY = 'trial-exit-dashboard-v1';
let weeklyChart = null;

// ─── Storage ───
function loadStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch { return {}; }
}

function saveStorage(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function getSnapshots(slug) {
  const data = loadStorage();
  return (data[slug] || []).sort((a, b) => a.date.localeCompare(b.date));
}

function addSnapshot(slug, snapshot) {
  const data = loadStorage();
  if (!data[slug]) data[slug] = [];
  const idx = data[slug].findIndex(s => s.date === snapshot.date);
  if (idx >= 0) data[slug][idx] = snapshot;
  else data[slug].push(snapshot);
  data[slug].sort((a, b) => a.date.localeCompare(b.date));
  saveStorage(data);
}

function clearAppData(slug) {
  const data = loadStorage();
  delete data[slug];
  saveStorage(data);
}

function hasAnyData() {
  const data = loadStorage();
  return Object.values(data).some(arr => arr && arr.length > 0);
}

// ─── CSV parsing ───
async function readFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    file.name.endsWith('.gz') ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
  });
}

async function parseCSV(file) {
  let text;
  if (file.name.endsWith('.gz')) {
    const buffer = await readFile(file);
    text = new TextDecoder().decode(pako.inflate(new Uint8Array(buffer)));
  } else {
    text = await readFile(file);
  }

  let result = Papa.parse(text, { header: true, delimiter: ';', skipEmptyLines: true });
  if (result.meta.fields && result.meta.fields.length <= 1) {
    result = Papa.parse(text, { header: true, delimiter: ',', skipEmptyLines: true });
  }

  const fields = result.meta.fields.map(f => f.trim().toLowerCase());
  const rows = result.data.map(row => {
    const n = {};
    for (const [k, v] of Object.entries(row)) n[k.trim().toLowerCase()] = v;
    return n;
  });
  return { fields, rows };
}

// ─── Classification ───
function classifyTrialExit(row) {
  const status = (row.status || '').toLowerCase().trim();
  const spent = parseFloat(row.total_spent) || 0;
  const hasBillingTs = row.most_recent_billing_issues_at && row.most_recent_billing_issues_at.trim() !== '';
  if (status === 'free_trial') return 'Still in Trial';
  if (spent > 0) return 'Converted';
  if (status.includes('billing_issue') || hasBillingTs) return 'Billing Issue';
  return 'Cancelled';
}

function parseTimestamp(val) {
  if (!val || val.trim() === '') return null;
  const num = Number(val);
  if (!isNaN(num) && num > 1e12) return new Date(num);
  if (!isNaN(num) && num > 1e9) return new Date(num * 1000);
  const d = new Date(val);
  return isNaN(d.getTime()) ? null : d;
}

function getWeekStart(date) {
  if (!date) return null;
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  const m = new Date(d);
  m.setDate(diff);
  return m.toISOString().split('T')[0];
}

// ─── Analysis ───
function computeRates(users) {
  const resolved = users.filter(u => u.outcome !== 'Still in Trial');
  const t = resolved.length;
  const c = resolved.filter(u => u.outcome === 'Converted').length;
  const ca = resolved.filter(u => u.outcome === 'Cancelled').length;
  const b = resolved.filter(u => u.outcome === 'Billing Issue').length;
  const inTrial = users.filter(u => u.outcome === 'Still in Trial').length;
  return {
    total_trials: users.length, resolved: t, in_trial: inTrial,
    converted: c, cancelled: ca, billing_issue: b,
    conversion_rate: t > 0 ? Math.round((c / t) * 10000) / 10000 : null,
    cancel_rate: t > 0 ? Math.round((ca / t) * 10000) / 10000 : null,
    billing_rate: t > 0 ? Math.round((b / t) * 10000) / 10000 : null,
  };
}

function analyzeData(rows) {
  const classified = rows.map(row => ({
    outcome: classifyTrialExit(row),
    product: row.latest_product || row.product_identifier || 'unknown',
    trialStart: parseTimestamp(row.trial_start_at),
    totalSpent: parseFloat(row.total_spent) || 0,
  }));

  const overall = computeRates(classified);

  // Weekly cohorts
  const weekMap = {};
  classified.forEach(u => {
    const week = getWeekStart(u.trialStart);
    if (!week) return;
    if (!weekMap[week]) weekMap[week] = [];
    weekMap[week].push(u);
  });

  const weekly_cohorts = Object.keys(weekMap).sort().map(week => {
    const rates = computeRates(weekMap[week]);
    rates.week_start = week;
    return rates;
  });

  // Product breakdown
  const prodMap = {};
  classified.forEach(u => {
    const p = u.product || 'unknown';
    if (!prodMap[p]) prodMap[p] = [];
    prodMap[p].push(u);
  });

  const products = Object.keys(prodMap).map(prod => {
    const rates = computeRates(prodMap[prod]);
    rates.product_id = prod;
    return rates;
  }).filter(p => p.resolved > 0).sort((a, b) => b.resolved - a.resolved);

  return {
    date: new Date().toISOString().split('T')[0],
    generated_at: new Date().toISOString(),
    overall, weekly_cohorts, products,
  };
}

// ─── File handling ───
async function handleFile(file) {
  const slug = document.getElementById('uploadAppSelect').value;
  const appName = APPS[slug]?.name || slug;
  document.getElementById('processingIndicator').style.display = '';

  try {
    const { fields, rows } = await parseCSV(file);
    if (!['status', 'total_spent'].every(f => fields.includes(f))) {
      throw new Error(`Missing required columns (status, total_spent). Found: ${fields.slice(0, 10).join(', ')}`);
    }

    const snapshot = analyzeData(rows);
    snapshot.app = appName;
    snapshot.row_count = rows.length;
    addSnapshot(slug, snapshot);

    populateAppSelector();
    document.getElementById('appSelector').value = slug;
    updateUploadZone();
    renderApp(slug);
    showToast(`Processed ${rows.length.toLocaleString()} users for ${appName}`, 'success');
  } catch (err) {
    showToast(`Error: ${err.message}`, 'error');
    console.error(err);
  } finally {
    document.getElementById('processingIndicator').style.display = 'none';
  }
}

// ─── Upload zone state ───
function updateUploadZone() {
  const zone = document.getElementById('uploadZone');
  if (hasAnyData()) {
    zone.classList.add('compact');
  } else {
    zone.classList.remove('compact');
  }
}

// ─── UI rendering ───
function populateAppSelector() {
  const sel = document.getElementById('appSelector');
  const current = sel.value;
  sel.innerHTML = '<option value="">Select app</option>';
  const data = loadStorage();

  for (const slug of Object.keys(APPS)) {
    const count = data[slug]?.length || 0;
    const opt = document.createElement('option');
    opt.value = slug;
    opt.textContent = APPS[slug].name + (count > 0 ? ` (${count})` : '');
    sel.appendChild(opt);
  }
  if (current) sel.value = current;
}

function filterWeeks(weeks, rangeDays) {
  if (!rangeDays || rangeDays <= 0) return weeks;
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - rangeDays);
  const cutoffStr = cutoff.toISOString().split('T')[0];
  return weeks.filter(w => w.week_start >= cutoffStr);
}

function renderApp(slug) {
  if (!slug) {
    document.getElementById('content').innerHTML = `
      <div class="empty-state">
        <h2>No data yet</h2>
        <p>Upload a RevenueCat "All Users" CSV export to get started.</p>
      </div>`;
    document.getElementById('clearBtn').style.display = 'none';
    return;
  }

  const snapshots = getSnapshots(slug);
  if (snapshots.length === 0) {
    document.getElementById('content').innerHTML = `
      <div class="empty-state">
        <h2>No data for ${APPS[slug]?.name || slug}</h2>
        <p>Upload a CSV export for this app.</p>
      </div>`;
    document.getElementById('clearBtn').style.display = 'none';
    return;
  }

  document.getElementById('clearBtn').style.display = '';
  const latest = snapshots[snapshots.length - 1];
  const prev = snapshots.length > 1 ? snapshots[snapshots.length - 2] : null;

  // Apply date range filter to weekly cohorts
  const rangeDays = parseInt(document.getElementById('rangeSelector').value);
  const allWeeks = latest.weekly_cohorts || [];
  const filteredWeeks = filterWeeks(allWeeks, rangeDays);

  // Recompute overall from filtered weeks if filtering is active
  let overall;
  if (rangeDays > 0 && filteredWeeks.length < allWeeks.length && filteredWeeks.length > 0) {
    // Sum up from filtered weeks
    let totalTrials = 0, resolved = 0, inTrial = 0, converted = 0, cancelled = 0, billing = 0;
    filteredWeeks.forEach(w => {
      totalTrials += w.total_trials;
      resolved += w.resolved;
      inTrial += w.in_trial;
      converted += w.converted;
      cancelled += w.cancelled;
      billing += w.billing_issue;
    });
    overall = {
      total_trials: totalTrials, resolved, in_trial: inTrial,
      converted, cancelled, billing_issue: billing,
      conversion_rate: resolved > 0 ? Math.round((converted / resolved) * 10000) / 10000 : null,
      cancel_rate: resolved > 0 ? Math.round((cancelled / resolved) * 10000) / 10000 : null,
      billing_rate: resolved > 0 ? Math.round((billing / resolved) * 10000) / 10000 : null,
    };
  } else {
    overall = latest.overall;
  }

  renderDashboard(slug, latest, prev, overall, filteredWeeks);
}

function renderDashboard(slug, latest, prev, overall, weeks) {
  const o = overall;

  function delta(current, previous, key, invert = false) {
    if (!previous || current[key] === null || previous.overall[key] === null) return '';
    const diff = current[key] - previous.overall[key];
    if (Math.abs(diff) < 0.001) return '<span class="delta neutral">—</span>';
    const isUp = diff > 0;
    const isGood = invert ? !isUp : isUp;
    const cls = isGood ? 'up' : 'down';
    const arrow = isUp ? '↑' : '↓';
    return `<span class="delta ${cls}">${arrow} ${Math.abs(diff * 100).toFixed(1)}pp</span>`;
  }

  const rangeDays = parseInt(document.getElementById('rangeSelector').value);
  const rangeLabel = rangeDays > 0 ? `Last ${rangeDays} days` : 'All time';

  document.getElementById('content').innerHTML = `
    <div class="history-bar">
      <span class="snapshots-info">Uploaded: ${latest.date} &middot; ${(latest.row_count || 0).toLocaleString()} users &middot; Showing: ${rangeLabel} (${weeks.length} weeks)</span>
    </div>

    <div class="metrics-row">
      <div class="metric-card">
        <div class="label">Conversion Rate</div>
        <div class="value" style="color: var(--green)">${o.conversion_rate !== null ? (o.conversion_rate * 100).toFixed(1) + '%' : '—'}</div>
        <div class="sub">${o.converted} of ${o.resolved} resolved</div>
        ${delta(o, prev, 'conversion_rate')}
      </div>
      <div class="metric-card">
        <div class="label">Cancel Rate</div>
        <div class="value" style="color: var(--red)">${o.cancel_rate !== null ? (o.cancel_rate * 100).toFixed(1) + '%' : '—'}</div>
        <div class="sub">${o.cancelled} of ${o.resolved} resolved</div>
        ${delta(o, prev, 'cancel_rate', true)}
      </div>
      <div class="metric-card">
        <div class="label">Billing Issue Rate</div>
        <div class="value" style="color: var(--yellow)">${o.billing_rate !== null ? (o.billing_rate * 100).toFixed(1) + '%' : '—'}</div>
        <div class="sub">${o.billing_issue} of ${o.resolved} resolved</div>
        ${delta(o, prev, 'billing_rate', true)}
      </div>
      <div class="metric-card">
        <div class="label">Total Trials</div>
        <div class="value">${o.total_trials.toLocaleString()}</div>
        <div class="sub">${o.in_trial} still in trial</div>
      </div>
    </div>

    ${weeks.length > 0 ? `
    <div class="chart-container">
      <h2>Weekly Cohort Trends</h2>
      <div class="chart-wrapper">
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>` : ''}

    <div class="tables-row">
      <div class="table-container">
        <h2>Weekly Cohorts</h2>
        <table id="weeklyTable"></table>
      </div>
      <div class="table-container">
        <h2>By Product</h2>
        <table id="productTable"></table>
      </div>
    </div>
  `;

  if (weeks.length > 0) renderWeeklyChart(weeks);
  renderWeeklyTable(weeks);
  renderProductTable(latest);
}

function renderWeeklyChart(weeks) {
  const ctx = document.getElementById('weeklyChart').getContext('2d');
  if (weeklyChart) weeklyChart.destroy();

  // Only chart weeks with resolved > 0 for meaningful rates
  const chartWeeks = weeks.filter(w => w.resolved > 0);

  const labels = chartWeeks.map(w => w.week_start);
  const convData = chartWeeks.map(w => w.conversion_rate !== null ? +(w.conversion_rate * 100).toFixed(1) : null);
  const cancelData = chartWeeks.map(w => w.cancel_rate !== null ? +(w.cancel_rate * 100).toFixed(1) : null);
  const billingData = chartWeeks.map(w => w.billing_rate !== null ? +(w.billing_rate * 100).toFixed(1) : null);

  weeklyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Conversion %', data: convData,
          borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,0.1)',
          fill: true, tension: 0.3, pointRadius: 4, borderWidth: 2,
        },
        {
          label: 'Cancel %', data: cancelData,
          borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)',
          fill: true, tension: 0.3, pointRadius: 4, borderWidth: 2,
        },
        {
          label: 'Billing Issue %', data: billingData,
          borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.1)',
          fill: true, tension: 0.3, pointRadius: 4, borderWidth: 2,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#8b90a0', usePointStyle: true, padding: 20 } },
        tooltip: {
          backgroundColor: '#1a1d27', borderColor: '#2e3345', borderWidth: 1,
          titleColor: '#e1e4ed', bodyColor: '#e1e4ed',
          callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y}%` }
        }
      },
      scales: {
        x: { grid: { color: '#2e3345' }, ticks: { color: '#8b90a0', maxRotation: 45 } },
        y: { grid: { color: '#2e3345' }, ticks: { color: '#8b90a0', callback: v => v + '%' }, min: 0, suggestedMax: 100 }
      }
    }
  });
}

function renderWeeklyTable(weeks) {
  const table = document.getElementById('weeklyTable');
  const recentWeeks = weeks.slice(-12);

  let html = `
    <thead><tr>
      <th>Week</th>
      <th class="text-right">Trials</th>
      <th class="text-right">Conv%</th>
      <th class="text-right">Cancel%</th>
      <th class="text-right">Billing%</th>
    </tr></thead><tbody>`;

  recentWeeks.forEach(w => {
    const convBadge = w.conversion_rate !== null
      ? `<span class="badge ${w.conversion_rate >= 0.25 ? 'badge-green' : 'badge-red'}">${(w.conversion_rate * 100).toFixed(1)}%</span>` : '—';
    const cancelPct = w.cancel_rate !== null ? `${(w.cancel_rate * 100).toFixed(1)}%` : '—';
    const billingBadge = w.billing_rate !== null
      ? `<span class="badge ${w.billing_rate >= 0.4 ? 'badge-red' : w.billing_rate >= 0.25 ? 'badge-yellow' : 'badge-green'}">${(w.billing_rate * 100).toFixed(1)}%</span>` : '—';

    html += `<tr>
      <td>${w.week_start}</td>
      <td class="text-right">${w.total_trials}</td>
      <td class="text-right">${convBadge}</td>
      <td class="text-right">${cancelPct}</td>
      <td class="text-right">${billingBadge}</td>
    </tr>`;
  });

  if (recentWeeks.length === 0) html += '<tr><td colspan="5" style="text-align:center; color: var(--text-dim)">No weekly data in this range</td></tr>';
  html += '</tbody>';
  table.innerHTML = html;
}

function renderProductTable(snapshot) {
  const table = document.getElementById('productTable');
  const products = (snapshot.products || []).filter(p => p.resolved > 0);

  let html = `
    <thead><tr>
      <th>Product</th>
      <th class="text-right">Resolved</th>
      <th class="text-right">Conv%</th>
      <th class="text-right">Billing%</th>
    </tr></thead><tbody>`;

  products.forEach(p => {
    const shortName = p.product_id.split('.').pop() || p.product_id;
    html += `<tr>
      <td title="${p.product_id}">${shortName}</td>
      <td class="text-right">${p.resolved}</td>
      <td class="text-right"><span class="badge ${p.conversion_rate >= 0.25 ? 'badge-green' : 'badge-red'}">${(p.conversion_rate * 100).toFixed(1)}%</span></td>
      <td class="text-right"><span class="badge ${p.billing_rate >= 0.4 ? 'badge-red' : 'badge-yellow'}">${(p.billing_rate * 100).toFixed(1)}%</span></td>
    </tr>`;
  });

  if (products.length === 0) html += '<tr><td colspan="4" style="text-align:center; color: var(--text-dim)">No product data</td></tr>';
  html += '</tbody>';
  table.innerHTML = html;
}

function showToast(msg, type = 'success') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

// ─── Events ───
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

document.getElementById('browseBtn').addEventListener('click', e => { e.stopPropagation(); fileInput.click(); });
uploadZone.addEventListener('click', e => {
  if (!['SELECT','BUTTON','OPTION'].includes(e.target.tagName)) fileInput.click();
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); e.target.value = ''; });
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });

document.getElementById('appSelector').addEventListener('change', e => renderApp(e.target.value));
document.getElementById('rangeSelector').addEventListener('change', () => {
  const slug = document.getElementById('appSelector').value;
  if (slug) renderApp(slug);
});

document.getElementById('clearBtn').addEventListener('click', () => {
  const slug = document.getElementById('appSelector').value;
  if (!slug) return;
  if (confirm(`Clear all stored data for ${APPS[slug]?.name || slug}?`)) {
    clearAppData(slug);
    populateAppSelector();
    updateUploadZone();
    renderApp(slug);
    showToast('Data cleared', 'success');
  }
});

// ─── Init ───
populateAppSelector();
updateUploadZone();

const stored = loadStorage();
const firstWithData = Object.keys(APPS).find(slug => stored[slug]?.length > 0);
if (firstWithData) {
  document.getElementById('appSelector').value = firstWithData;
  renderApp(firstWithData);
}
</script>
</body>
</html>
