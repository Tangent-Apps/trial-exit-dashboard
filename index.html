<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trial Exit Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2e3345;
    --text: #e1e4ed;
    --text-dim: #8b90a0;
    --green: #34d399;
    --red: #f87171;
    --yellow: #fbbf24;
    --blue: #60a5fa;
    --purple: #a78bfa;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }

  .header h1 { font-size: 20px; font-weight: 600; letter-spacing: -0.02em; }

  .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

  select, button {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    outline: none;
  }

  select:hover, button:hover { border-color: var(--blue); }

  button.primary {
    background: var(--blue);
    border-color: var(--blue);
    color: #fff;
    font-weight: 500;
  }

  button.primary:hover { background: #4f8fef; }

  button.danger {
    background: rgba(248,113,113,0.15);
    border-color: var(--red);
    color: var(--red);
    font-size: 12px;
    padding: 6px 10px;
  }

  button.danger:hover { background: rgba(248,113,113,0.3); }

  .container { padding: 24px 32px; max-width: 1400px; margin: 0 auto; }

  /* Upload popover */
  .upload-wrapper { position: relative; }

  .upload-popover {
    display: none;
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    z-index: 100;
    min-width: 260px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }

  .upload-popover.open { display: block; }

  .upload-popover label { font-size: 13px; color: var(--text-dim); display: block; margin-bottom: 6px; }

  .upload-popover select {
    width: 100%;
    margin-bottom: 12px;
  }

  .upload-popover .upload-actions {
    display: flex;
    gap: 8px;
  }

  .upload-popover .upload-actions button { flex: 1; }

  .upload-popover input[type="file"] { display: none; }

  /* Full-page empty state with upload prompt */
  .empty-upload {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 60px 24px;
    text-align: center;
    cursor: pointer;
    background: var(--surface);
    transition: all 0.2s;
  }

  .empty-upload:hover {
    border-color: var(--blue);
    background: rgba(96,165,250,0.05);
  }

  .empty-upload h2 { font-size: 20px; margin-bottom: 8px; }
  .empty-upload p { font-size: 14px; color: var(--text-dim); margin-bottom: 16px; }

  .empty-upload .inline-upload {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
  }

  .empty-upload .inline-upload label { font-size: 13px; color: var(--text-dim); }

  /* Processing indicator */
  .processing {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: rgba(96,165,250,0.1);
    border: 1px solid rgba(96,165,250,0.3);
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 14px;
  }

  .spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--blue);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Metrics cards */
  .metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .metric-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .metric-card .label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .metric-card .value { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; }
  .metric-card .sub { font-size: 13px; color: var(--text-dim); margin-top: 4px; }
  .metric-card .delta { font-size: 13px; margin-top: 4px; font-weight: 500; }

  .delta.up { color: var(--green); }
  .delta.down { color: var(--red); }
  .delta.neutral { color: var(--text-dim); }

  /* Charts */
  .chart-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .chart-container h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
  .chart-wrapper { position: relative; height: 320px; }

  /* Tables */
  .tables-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  @media (max-width: 900px) { .tables-row { grid-template-columns: 1fr; } }

  .table-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    overflow-x: auto;
  }

  .table-container h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }

  th {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 500;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  .text-right { text-align: right; }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
  }

  .badge-green { background: rgba(52,211,153,0.15); color: var(--green); }
  .badge-red { background: rgba(248,113,113,0.15); color: var(--red); }
  .badge-yellow { background: rgba(251,191,36,0.15); color: var(--yellow); }

  .empty-state {
    text-align: center;
    padding: 60px 24px;
    color: var(--text-dim);
  }

  .empty-state h2 { font-size: 20px; margin-bottom: 8px; color: var(--text); }

  .history-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .history-bar .snapshots-info { font-size: 13px; color: var(--text-dim); }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 14px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    animation: fadeIn 0.3s;
    max-width: 400px;
  }

  .toast.success { background: rgba(52,211,153,0.2); border: 1px solid var(--green); color: var(--green); }
  .toast.error { background: rgba(248,113,113,0.2); border: 1px solid var(--red); color: var(--red); }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>

<div class="header">
  <h1>Trial Exit Dashboard</h1>
  <div class="controls">
    <select id="appSelector">
      <option value="">Select app</option>
    </select>
    <select id="granularitySelector">
      <option value="daily">Daily</option>
      <option value="weekly" selected>Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <select id="rangeSelector">
      <option value="30">Last 30 days</option>
      <option value="60">Last 60 days</option>
      <option value="90">Last 90 days</option>
      <option value="0" selected>All time</option>
    </select>
    <div class="upload-wrapper">
      <button class="primary" id="uploadBtn">↑ Upload CSV</button>
      <div class="upload-popover" id="uploadPopover">
        <label for="uploadAppSelect">App</label>
        <select id="uploadAppSelect">
          <option value="christian-daily-task">Christian Daily Task</option>
          <option value="girlwalk">GirlWalk</option>
          <option value="girltalk">GirlTalk</option>
        </select>
        <div class="upload-actions">
          <button class="primary" id="browseBtn">Browse file</button>
        </div>
        <input type="file" id="fileInput" accept=".csv,.gz,.csv.gz">
      </div>
    </div>
    <button class="danger" id="clearBtn" style="display:none" title="Clear all stored data for this app">Clear</button>
  </div>
</div>

<div class="container">
  <div id="processingIndicator" style="display:none">
    <div class="processing">
      <div class="spinner"></div>
      <span>Processing CSV...</span>
    </div>
  </div>

  <div id="content"></div>
</div>

<script>
const APPS = {
  'christian-daily-task': { name: 'Christian Daily Task' },
  'girlwalk': { name: 'GirlWalk' },
  'girltalk': { name: 'GirlTalk' },
};

const STORAGE_KEY = 'trial-exit-dashboard-v2';
const MIN_TRIALS_FOR_RATE = 5; // Don't show rates for cohorts with fewer trials (too noisy)
let cohortChart = null;

// ─── Storage ───
function loadStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch { return {}; }
}

function saveStorage(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function getSnapshots(slug) {
  const data = loadStorage();
  return (data[slug] || []).sort((a, b) => a.date.localeCompare(b.date));
}

function addSnapshot(slug, snapshot) {
  const data = loadStorage();
  if (!data[slug]) data[slug] = [];
  const idx = data[slug].findIndex(s => s.date === snapshot.date);
  if (idx >= 0) data[slug][idx] = snapshot;
  else data[slug].push(snapshot);
  data[slug].sort((a, b) => a.date.localeCompare(b.date));
  saveStorage(data);
}

function clearAppData(slug) {
  const data = loadStorage();
  delete data[slug];
  saveStorage(data);
}

function hasAnyData() {
  const data = loadStorage();
  return Object.values(data).some(arr => arr && arr.length > 0);
}

// ─── CSV parsing ───
async function readFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    file.name.endsWith('.gz') ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
  });
}

async function parseCSV(file) {
  let text;
  if (file.name.endsWith('.gz')) {
    const buffer = await readFile(file);
    text = new TextDecoder().decode(pako.inflate(new Uint8Array(buffer)));
  } else {
    text = await readFile(file);
  }

  let result = Papa.parse(text, { header: true, delimiter: ';', skipEmptyLines: true });
  if (result.meta.fields && result.meta.fields.length <= 1) {
    result = Papa.parse(text, { header: true, delimiter: ',', skipEmptyLines: true });
  }

  const fields = result.meta.fields.map(f => f.trim().toLowerCase());
  const rows = result.data.map(row => {
    const n = {};
    for (const [k, v] of Object.entries(row)) n[k.trim().toLowerCase()] = v;
    return n;
  });
  return { fields, rows };
}

// ─── Classification ───
function classifyTrialExit(row) {
  const status = (row.status || '').toLowerCase().trim();
  const spent = parseFloat(row.total_spent) || 0;
  const hasBillingTs = row.most_recent_billing_issues_at && row.most_recent_billing_issues_at.trim() !== '';
  if (status === 'free_trial') return 'Still in Trial';
  if (spent > 0) return 'Converted';
  if (status.includes('billing_issue') || hasBillingTs) return 'Billing Issue';
  return 'Cancelled';
}

function parseTimestamp(val) {
  if (!val || val.trim() === '') return null;
  const num = Number(val);
  if (!isNaN(num) && num > 1e12) return new Date(num);
  if (!isNaN(num) && num > 1e9) return new Date(num * 1000);
  const d = new Date(val);
  return isNaN(d.getTime()) ? null : d;
}

function getDateKey(date) {
  if (!date) return null;
  const y = date.getUTCFullYear();
  const m = String(date.getUTCMonth() + 1).padStart(2, '0');
  const d = String(date.getUTCDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function getWeekStart(date) {
  if (!date) return null;
  const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
  const day = d.getUTCDay(); // 0=Sun, 1=Mon, ...
  const diff = day === 0 ? -6 : 1 - day;
  d.setUTCDate(d.getUTCDate() + diff);
  return getDateKey(d);
}

function getMonthKey(date) {
  if (!date) return null;
  const y = date.getUTCFullYear();
  const m = String(date.getUTCMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
}

function bucketCohorts(dailyCohorts, granularity) {
  if (granularity === 'daily') return dailyCohorts;
  const map = {};
  dailyCohorts.forEach(d => {
    const dateObj = new Date(d.period + 'T12:00:00Z');
    const key = granularity === 'monthly' ? getMonthKey(dateObj) : getWeekStart(dateObj);
    if (!key) return;
    if (!map[key]) map[key] = { period: key, total_trials: 0, resolved: 0, in_trial: 0, converted: 0, cancelled: 0, billing_issue: 0 };
    map[key].total_trials += d.total_trials;
    map[key].resolved += d.resolved;
    map[key].in_trial += d.in_trial;
    map[key].converted += d.converted;
    map[key].cancelled += d.cancelled;
    map[key].billing_issue += d.billing_issue;
  });
  return Object.keys(map).sort().map(key => {
    const b = map[key];
    b.conversion_rate = b.total_trials > 0 ? Math.round((b.converted / b.total_trials) * 10000) / 10000 : null;
    b.cancel_rate = b.total_trials > 0 ? Math.round((b.cancelled / b.total_trials) * 10000) / 10000 : null;
    b.billing_rate = b.total_trials > 0 ? Math.round((b.billing_issue / b.total_trials) * 10000) / 10000 : null;
    return b;
  });
}

// ─── Analysis ───
function computeRates(users) {
  const total = users.length;
  const c = users.filter(u => u.outcome === 'Converted').length;
  const ca = users.filter(u => u.outcome === 'Cancelled').length;
  const b = users.filter(u => u.outcome === 'Billing Issue').length;
  const inTrial = users.filter(u => u.outcome === 'Still in Trial').length;
  const resolved = total - inTrial;
  return {
    total_trials: total, resolved, in_trial: inTrial,
    converted: c, cancelled: ca, billing_issue: b,
    conversion_rate: total > 0 ? Math.round((c / total) * 10000) / 10000 : null,
    cancel_rate: total > 0 ? Math.round((ca / total) * 10000) / 10000 : null,
    billing_rate: total > 0 ? Math.round((b / total) * 10000) / 10000 : null,
  };
}

function analyzeData(rows) {
  const classified = rows.map(row => ({
    outcome: classifyTrialExit(row),
    product: row.latest_product || row.product_identifier || 'unknown',
    trialStart: parseTimestamp(row.trial_start_at),
    totalSpent: parseFloat(row.total_spent) || 0,
  }));

  const overall = computeRates(classified);

  // Daily cohorts (stored as base; bucketed to weekly/monthly on the fly)
  const dayMap = {};
  classified.forEach(u => {
    const day = getDateKey(u.trialStart);
    if (!day) return;
    if (!dayMap[day]) dayMap[day] = [];
    dayMap[day].push(u);
  });

  const daily_cohorts = Object.keys(dayMap).sort().map(day => {
    const rates = computeRates(dayMap[day]);
    rates.period = day;
    return rates;
  });

  // Product breakdown
  const prodMap = {};
  classified.forEach(u => {
    const p = u.product || 'unknown';
    if (!prodMap[p]) prodMap[p] = [];
    prodMap[p].push(u);
  });

  const products = Object.keys(prodMap).map(prod => {
    const rates = computeRates(prodMap[prod]);
    rates.product_id = prod;
    return rates;
  }).filter(p => p.total_trials > 0).sort((a, b) => b.total_trials - a.total_trials);

  return {
    date: new Date().toISOString().split('T')[0],
    generated_at: new Date().toISOString(),
    overall, daily_cohorts, products,
  };
}

// ─── File handling ───
async function handleFile(file) {
  const slug = document.getElementById('uploadAppSelect').value;
  const appName = APPS[slug]?.name || slug;
  document.getElementById('processingIndicator').style.display = '';

  try {
    const { fields, rows } = await parseCSV(file);
    if (!['status', 'total_spent'].every(f => fields.includes(f))) {
      throw new Error(`Missing required columns (status, total_spent). Found: ${fields.slice(0, 10).join(', ')}`);
    }

    const snapshot = analyzeData(rows);
    snapshot.app = appName;
    snapshot.row_count = rows.length;
    addSnapshot(slug, snapshot);

    populateAppSelector();
    document.getElementById('appSelector').value = slug;
    closePopover();
    renderApp(slug);
    showToast(`Processed ${rows.length.toLocaleString()} users for ${appName}`, 'success');
  } catch (err) {
    showToast(`Error: ${err.message}`, 'error');
    console.error(err);
  } finally {
    document.getElementById('processingIndicator').style.display = 'none';
  }
}

// ─── Upload popover ───
function closePopover() {
  document.getElementById('uploadPopover').classList.remove('open');
}

// ─── UI rendering ───
function populateAppSelector() {
  const sel = document.getElementById('appSelector');
  const current = sel.value;
  sel.innerHTML = '<option value="">Select app</option>';
  const data = loadStorage();

  for (const slug of Object.keys(APPS)) {
    const opt = document.createElement('option');
    opt.value = slug;
    opt.textContent = APPS[slug].name;
    sel.appendChild(opt);
  }
  if (current) sel.value = current;
}

function filterCohorts(cohorts, rangeDays) {
  if (!rangeDays || rangeDays <= 0) return cohorts;
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - rangeDays);
  const cutoffStr = cutoff.toISOString().split('T')[0];
  return cohorts.filter(c => c.period >= cutoffStr);
}

function renderApp(slug) {
  if (!slug || !getSnapshots(slug).length) {
    const appLabel = slug ? APPS[slug]?.name || slug : '';
    document.getElementById('content').innerHTML = `
      <div class="empty-upload" id="emptyUpload">
        <h2>${slug ? `No data for ${appLabel}` : 'No data yet'}</h2>
        <p>Upload a RevenueCat "All Users" CSV export to get started</p>
        <div class="inline-upload">
          <label for="emptyAppSelect">App:</label>
          <select id="emptyAppSelect">
            <option value="christian-daily-task"${slug === 'christian-daily-task' ? ' selected' : ''}>Christian Daily Task</option>
            <option value="girlwalk"${slug === 'girlwalk' ? ' selected' : ''}>GirlWalk</option>
            <option value="girltalk"${slug === 'girltalk' ? ' selected' : ''}>GirlTalk</option>
          </select>
          <button class="primary" id="emptyBrowseBtn">Browse file</button>
          <input type="file" id="emptyFileInput" accept=".csv,.gz,.csv.gz" style="display:none">
        </div>
      </div>`;
    // Wire up empty-state upload
    const emptyFileInput = document.getElementById('emptyFileInput');
    document.getElementById('emptyBrowseBtn').addEventListener('click', e => { e.stopPropagation(); emptyFileInput.click(); });
    document.getElementById('emptyUpload').addEventListener('click', e => {
      if (!['SELECT','BUTTON','OPTION'].includes(e.target.tagName)) emptyFileInput.click();
    });
    emptyFileInput.addEventListener('change', e => {
      if (e.target.files[0]) {
        document.getElementById('uploadAppSelect').value = document.getElementById('emptyAppSelect').value;
        handleFile(e.target.files[0]);
      }
      e.target.value = '';
    });
    // Drag & drop on empty state
    const emptyZone = document.getElementById('emptyUpload');
    emptyZone.addEventListener('dragover', e => { e.preventDefault(); emptyZone.style.borderColor = 'var(--blue)'; });
    emptyZone.addEventListener('dragleave', () => { emptyZone.style.borderColor = ''; });
    emptyZone.addEventListener('drop', e => {
      e.preventDefault(); emptyZone.style.borderColor = '';
      if (e.dataTransfer.files[0]) {
        document.getElementById('uploadAppSelect').value = document.getElementById('emptyAppSelect').value;
        handleFile(e.dataTransfer.files[0]);
      }
    });
    document.getElementById('clearBtn').style.display = 'none';
    return;
  }

  const snapshots = getSnapshots(slug);

  document.getElementById('clearBtn').style.display = '';
  const latest = snapshots[snapshots.length - 1];
  const prev = snapshots.length > 1 ? snapshots[snapshots.length - 2] : null;

  // Get daily cohorts (support old weekly_cohorts format for backward compat)
  const granularity = document.getElementById('granularitySelector').value;
  const rangeDays = parseInt(document.getElementById('rangeSelector').value);

  let dailyCohorts = latest.daily_cohorts || [];
  // Backward compat: convert old weekly_cohorts to period-based format
  if (dailyCohorts.length === 0 && latest.weekly_cohorts) {
    dailyCohorts = latest.weekly_cohorts.map(w => ({ ...w, period: w.week_start }));
  }

  const allCohorts = bucketCohorts(dailyCohorts, granularity);
  const filteredCohorts = filterCohorts(allCohorts, rangeDays);

  // Recompute overall from filtered cohorts if filtering is active
  let overall;
  if (rangeDays > 0 && filteredCohorts.length < allCohorts.length && filteredCohorts.length > 0) {
    let totalTrials = 0, resolved = 0, inTrial = 0, converted = 0, cancelled = 0, billing = 0;
    filteredCohorts.forEach(c => {
      totalTrials += c.total_trials;
      resolved += c.resolved;
      inTrial += c.in_trial;
      converted += c.converted;
      cancelled += c.cancelled;
      billing += c.billing_issue;
    });
    overall = {
      total_trials: totalTrials, resolved, in_trial: inTrial,
      converted, cancelled, billing_issue: billing,
      conversion_rate: totalTrials > 0 ? Math.round((converted / totalTrials) * 10000) / 10000 : null,
      cancel_rate: totalTrials > 0 ? Math.round((cancelled / totalTrials) * 10000) / 10000 : null,
      billing_rate: totalTrials > 0 ? Math.round((billing / totalTrials) * 10000) / 10000 : null,
    };
  } else {
    overall = latest.overall;
  }

  renderDashboard(slug, latest, prev, overall, filteredCohorts, granularity);
}

function renderDashboard(slug, latest, prev, overall, cohorts, granularity) {
  const o = overall;
  const granLabel = { daily: 'Day', weekly: 'Week', monthly: 'Month' }[granularity] || 'Week';
  const granLabelPlural = { daily: 'days', weekly: 'weeks', monthly: 'months' }[granularity] || 'weeks';

  function delta(current, previous, key, invert = false) {
    if (!previous || current[key] === null || previous.overall[key] === null) return '';
    const diff = current[key] - previous.overall[key];
    if (Math.abs(diff) < 0.001) return '<span class="delta neutral">—</span>';
    const isUp = diff > 0;
    const isGood = invert ? !isUp : isUp;
    const cls = isGood ? 'up' : 'down';
    const arrow = isUp ? '↑' : '↓';
    return `<span class="delta ${cls}">${arrow} ${Math.abs(diff * 100).toFixed(1)}pp</span>`;
  }

  const rangeDays = parseInt(document.getElementById('rangeSelector').value);
  const rangeLabel = rangeDays > 0 ? `Last ${rangeDays} days` : 'All time';

  document.getElementById('content').innerHTML = `
    <div class="history-bar">
      <span class="snapshots-info">Uploaded: ${latest.date} &middot; ${(latest.row_count || 0).toLocaleString()} users &middot; Showing: ${rangeLabel} (${cohorts.length} ${granLabelPlural})</span>
    </div>

    <div class="metrics-row">
      <div class="metric-card">
        <div class="label">Conversion Rate</div>
        <div class="value" style="color: var(--green)">${o.conversion_rate !== null ? (o.conversion_rate * 100).toFixed(1) + '%' : '—'}</div>
        <div class="sub">${o.converted} of ${o.total_trials} trials</div>
        ${delta(o, prev, 'conversion_rate')}
      </div>
      <div class="metric-card">
        <div class="label">Cancel Rate</div>
        <div class="value" style="color: var(--red)">${o.cancel_rate !== null ? (o.cancel_rate * 100).toFixed(1) + '%' : '—'}</div>
        <div class="sub">${o.cancelled} of ${o.total_trials} trials</div>
        ${delta(o, prev, 'cancel_rate', true)}
      </div>
      <div class="metric-card">
        <div class="label">Billing Issue Rate</div>
        <div class="value" style="color: var(--yellow)">${o.billing_rate !== null ? (o.billing_rate * 100).toFixed(1) + '%' : '—'}</div>
        <div class="sub">${o.billing_issue} of ${o.total_trials} trials</div>
        ${delta(o, prev, 'billing_rate', true)}
      </div>
      <div class="metric-card">
        <div class="label">Total Trials</div>
        <div class="value">${o.total_trials.toLocaleString()}</div>
        <div class="sub">${o.in_trial} still in trial</div>
      </div>
    </div>

    ${cohorts.length > 0 ? `
    <div class="chart-container">
      <h2>Cohort Trends (${granLabel})</h2>
      <div class="chart-wrapper">
        <canvas id="cohortChart"></canvas>
      </div>
    </div>` : ''}

    <div class="tables-row">
      <div class="table-container">
        <h2>Cohorts (${granLabel})</h2>
        <table id="cohortTable"></table>
      </div>
      <div class="table-container">
        <h2>By Product</h2>
        <table id="productTable"></table>
      </div>
    </div>
  `;

  if (cohorts.length > 0) renderCohortChart(cohorts, granularity);
  renderCohortTable(cohorts, granLabel);
  renderProductTable(latest);
}

// Fill gaps in the timeline so the chart x-axis is continuous
function fillTimelineGaps(cohorts, granularity) {
  if (cohorts.length < 2) return cohorts;
  const map = {};
  cohorts.forEach(c => { map[c.period] = c; });

  const firstP = cohorts[0].period;
  const lastP = cohorts[cohorts.length - 1].period;
  // Parse periods as UTC noon to avoid timezone edge cases
  const start = granularity === 'monthly'
    ? new Date(firstP + '-01T12:00:00Z')
    : new Date(firstP + 'T12:00:00Z');
  const end = granularity === 'monthly'
    ? new Date(lastP + '-01T12:00:00Z')
    : new Date(lastP + 'T12:00:00Z');
  const result = [];
  const cursor = new Date(start);

  while (cursor <= end) {
    const key = granularity === 'monthly' ? getMonthKey(cursor) : getDateKey(cursor);

    if (map[key]) {
      result.push(map[key]);
    } else {
      result.push({ period: key, resolved: 0, conversion_rate: null, cancel_rate: null, billing_rate: null, total_trials: 0 });
    }

    // Advance cursor in UTC
    if (granularity === 'monthly') {
      cursor.setUTCMonth(cursor.getUTCMonth() + 1);
    } else if (granularity === 'weekly') {
      cursor.setUTCDate(cursor.getUTCDate() + 7);
    } else {
      cursor.setUTCDate(cursor.getUTCDate() + 1);
    }
  }
  return result;
}

function renderCohortChart(cohorts, granularity) {
  const ctx = document.getElementById('cohortChart').getContext('2d');
  if (cohortChart) cohortChart.destroy();

  // Fill gaps so the timeline is continuous
  const filled = fillTimelineGaps(cohorts, granularity);
  // Only show rates for periods with resolved data; null otherwise (gaps in chart line)
  const labels = filled.map(c => c.period);
  // Only show rates when cohort has enough trials for meaningful data
  const convData = filled.map(c => c.total_trials >= MIN_TRIALS_FOR_RATE ? +(c.conversion_rate * 100).toFixed(1) : null);
  const cancelData = filled.map(c => c.total_trials >= MIN_TRIALS_FOR_RATE ? +(c.cancel_rate * 100).toFixed(1) : null);
  const billingData = filled.map(c => c.total_trials >= MIN_TRIALS_FOR_RATE ? +(c.billing_rate * 100).toFixed(1) : null);

  const trialsData = filled.map(c => c.total_trials || 0);

  cohortChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Trials', data: trialsData,
          type: 'bar', yAxisID: 'y1',
          backgroundColor: 'rgba(160,174,192,0.15)',
          borderColor: 'rgba(160,174,192,0.25)',
          borderWidth: 1, borderRadius: 3,
          order: 1,
        },
        {
          label: 'Conversion %', data: convData,
          borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,0.1)',
          fill: false, tension: 0.3, pointRadius: granularity === 'daily' ? 2 : 4, borderWidth: 2, spanGaps: true,
          yAxisID: 'y', order: 0,
        },
        {
          label: 'Cancel %', data: cancelData,
          borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)',
          fill: false, tension: 0.3, pointRadius: granularity === 'daily' ? 2 : 4, borderWidth: 2, spanGaps: true,
          yAxisID: 'y', order: 0,
        },
        {
          label: 'Billing Issue %', data: billingData,
          borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.1)',
          fill: false, tension: 0.3, pointRadius: granularity === 'daily' ? 2 : 4, borderWidth: 2, spanGaps: true,
          yAxisID: 'y', order: 0,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#8b90a0', usePointStyle: true, padding: 20 } },
        tooltip: {
          backgroundColor: '#1a1d27', borderColor: '#2e3345', borderWidth: 1,
          titleColor: '#e1e4ed', bodyColor: '#e1e4ed',
          callbacks: {
            label: c => c.dataset.label === 'Trials'
              ? `${c.dataset.label}: ${c.parsed.y}`
              : `${c.dataset.label}: ${c.parsed.y}%`
          }
        }
      },
      scales: {
        x: { grid: { color: '#2e3345' }, ticks: { color: '#8b90a0', maxRotation: 45 } },
        y: { position: 'left', grid: { color: '#2e3345' }, ticks: { color: '#8b90a0', callback: v => v + '%' }, min: 0, suggestedMax: 100 },
        y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#555d70' }, min: 0, title: { display: true, text: 'Trials', color: '#555d70', font: { size: 11 } } }
      }
    }
  });
}

function renderCohortTable(cohorts, granLabel) {
  const table = document.getElementById('cohortTable');
  const recent = cohorts.slice(-20);

  let html = `
    <thead><tr>
      <th>${granLabel}</th>
      <th class="text-right">Trials</th>
      <th class="text-right">Conv%</th>
      <th class="text-right">Cancel%</th>
      <th class="text-right">Billing%</th>
    </tr></thead><tbody>`;

  recent.forEach(c => {
    const lowSample = c.total_trials < MIN_TRIALS_FOR_RATE;
    const dimStyle = lowSample ? ' style="opacity:0.35"' : '';
    const convBadge = c.conversion_rate !== null
      ? `<span class="badge ${c.conversion_rate >= 0.25 ? 'badge-green' : 'badge-red'}"${dimStyle}>${(c.conversion_rate * 100).toFixed(1)}%</span>` : '—';
    const cancelPct = c.cancel_rate !== null
      ? `<span${dimStyle}>${(c.cancel_rate * 100).toFixed(1)}%</span>` : '—';
    const billingBadge = c.billing_rate !== null
      ? `<span class="badge ${c.billing_rate >= 0.4 ? 'badge-red' : c.billing_rate >= 0.25 ? 'badge-yellow' : 'badge-green'}"${dimStyle}>${(c.billing_rate * 100).toFixed(1)}%</span>` : '—';

    html += `<tr>
      <td>${c.period}</td>
      <td class="text-right">${c.total_trials}${lowSample ? '<span style="color:var(--text-dim);font-size:11px"> ⚬</span>' : ''}</td>
      <td class="text-right">${convBadge}</td>
      <td class="text-right">${cancelPct}</td>
      <td class="text-right">${billingBadge}</td>
    </tr>`;
  });

  if (recent.length === 0) html += '<tr><td colspan="5" style="text-align:center; color: var(--text-dim)">No data in this range</td></tr>';
  html += '</tbody>';
  table.innerHTML = html;
}

function renderProductTable(snapshot) {
  const table = document.getElementById('productTable');
  const products = (snapshot.products || []).filter(p => p.total_trials > 0);

  let html = `
    <thead><tr>
      <th>Product</th>
      <th class="text-right">Trials</th>
      <th class="text-right">Conv%</th>
      <th class="text-right">Billing%</th>
    </tr></thead><tbody>`;

  products.forEach(p => {
    const shortName = p.product_id.split('.').pop() || p.product_id;
    const lowSample = p.total_trials < MIN_TRIALS_FOR_RATE;
    const dimStyle = lowSample ? ' style="opacity:0.35"' : '';
    html += `<tr>
      <td title="${p.product_id}">${shortName}</td>
      <td class="text-right">${p.total_trials}${lowSample ? '<span style="color:var(--text-dim);font-size:11px"> ⚬</span>' : ''}</td>
      <td class="text-right"><span class="badge ${p.conversion_rate >= 0.25 ? 'badge-green' : 'badge-red'}"${dimStyle}>${(p.conversion_rate * 100).toFixed(1)}%</span></td>
      <td class="text-right"><span class="badge ${p.billing_rate >= 0.4 ? 'badge-red' : 'badge-yellow'}"${dimStyle}>${(p.billing_rate * 100).toFixed(1)}%</span></td>
    </tr>`;
  });

  if (products.length === 0) html += '<tr><td colspan="4" style="text-align:center; color: var(--text-dim)">No product data</td></tr>';
  html += '</tbody>';
  table.innerHTML = html;
}

function showToast(msg, type = 'success') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

// ─── Events ───
const fileInput = document.getElementById('fileInput');
const uploadPopover = document.getElementById('uploadPopover');

// Toggle popover
document.getElementById('uploadBtn').addEventListener('click', e => {
  e.stopPropagation();
  uploadPopover.classList.toggle('open');
});

// Close popover on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.upload-wrapper')) closePopover();
});

document.getElementById('browseBtn').addEventListener('click', e => { e.stopPropagation(); fileInput.click(); });
fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); e.target.value = ''; });

document.getElementById('appSelector').addEventListener('change', e => renderApp(e.target.value));
document.getElementById('rangeSelector').addEventListener('change', () => {
  const slug = document.getElementById('appSelector').value;
  if (slug) renderApp(slug);
});
document.getElementById('granularitySelector').addEventListener('change', () => {
  const slug = document.getElementById('appSelector').value;
  if (slug) renderApp(slug);
});

document.getElementById('clearBtn').addEventListener('click', () => {
  const slug = document.getElementById('appSelector').value;
  if (!slug) return;
  if (confirm(`Clear all stored data for ${APPS[slug]?.name || slug}?`)) {
    clearAppData(slug);
    populateAppSelector();
    renderApp(slug);
    showToast('Data cleared', 'success');
  }
});

// ─── Init ───
// Migrate v1 data to v2 if needed
(function migrateStorage() {
  const v2 = localStorage.getItem('trial-exit-dashboard-v2');
  if (!v2) {
    const v1 = localStorage.getItem('trial-exit-dashboard-v1');
    if (v1) {
      localStorage.setItem('trial-exit-dashboard-v2', v1);
      // v1 data has weekly_cohorts; backward compat in renderApp handles it
    }
  }
})();

populateAppSelector();

const stored = loadStorage();
const firstWithData = Object.keys(APPS).find(slug => stored[slug]?.length > 0);
if (firstWithData) {
  document.getElementById('appSelector').value = firstWithData;
  renderApp(firstWithData);
}
</script>
</body>
</html>
